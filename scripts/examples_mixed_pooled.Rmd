---
title: "Pooled meta-analysis methods"
author: "Dario San-Segundo-Molina, Ignacio Morales-Castilla, Sara Villen-Perez;"
date: "13/1/2022"
output: html_document
references: references.bib
csl: ecography.csl
bibliography: references.bib
editor_options: 
  markdown: 
    wrap: 72
---

El objetivo del documento es probar modelos mixtos con un subset de
nuestros datos

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(brms)
library(nlme)
library(knitr)
library(dmetar)
library(sjstats)
library(parameters)
SuicidePrevention #data from dmetar package in meta-analysis context

briere1 <- function(a, temp, Tmin, Tmax){
  a*temp*(temp-Tmin)*(Tmax-temp)^(1/2)
}
# Since Topt is not a direct parameter of the model, it can be derived from Tmin and Tmax
# according to Marchioro & Foerster, 2011:
Topt <- function(Tmin,Tmax,m){
  Topt=((2*m*Tmax+(m+1)*Tmin)+sqrt(4*(m^2)*(Tmax^2)+((m+1)^2)*(Tmin^2)-4*(m^2)*Tmin*Tmax))/(4*m+2)
  return(Topt)
}
```

Para ello, primero cargamos los datos y cogemos solo los de ácaros.

```{r}
#  intrapest_test <-read_csv("/Users/dario-ssm/Documents/Dario Investigacion#   /IntRaPest/intrinsic_rates_pests/data/IR_data_complete_sim.csv" ) %>%
#     filter(id != 19 & id != 47 & order == "Acari>Prostigmata" | order =="Acari#   >Trombidiformes") %>% 
#     mutate(order = "Acari") %>% 
#     mutate(weights_meta = 1/(sd^2)) %>% 
#     glimpse()
#   
#   kable(intrapest_test)
```

## 1. `nlme` package

#### a) `lme()`

Asumiendo linealidad para comprender la estructura del modelo y del
output, probamos con esta función primero.

Probamos primero modelo *random-effects* para la tasa de crecimiento
intrínseco sin tener en cuenta la temperatura

```{r}
 re_lme_acari <- lme(r ~ 1, 
                     random = ~ 1|id,
                     weights = ~ weights_meta,
                     data = intrapest_test) 
 summary(re_lme_acari)
```

Error log-cholesky, para variar. Es que claramente esto no es linear.

```{r}
 re_lme_acari <- lme(r ~ temp, 
                     random = ~ 1|id,
                     weights = ~ weights_meta,
                     data = intrapest_test) 
 summary(re_lme_acari)
```

De esa tabla destacan:

-   La **between-studies** variance (Q~bet~ = 0.065) y la
    **within-studies** variance

#### b) nlme()

```{r}
start_nls <- gnls(r ~ briere1(a,temp = temp,Tmin,Tmax),
                  start = c(a = 9e-05, Tmin = 8, Tmax = 40),
                  weights = varExp(0.025,~weights_meta),
                  data = intrapest_test,
                  control = gnlsControl(nlsTol = 1,
                                        tolerance = 1))
startvals_sum <- summary(start_nls)
startvals <- coef(startvals_sum)[1:3,1]
nlme_random_temp_only <- nlme(model= r ~ briere1(a,temp = temp,Tmin,Tmax),
                              start = startvals, 
                              fixed = a+Tmin+Tmax ~ 1, 
                              random =a+Tmin+Tmax ~ 1|id,
                              weights = varExp(,temp~weights_meta),
                              data = intrapest_test,
                              control = nlmeControl(pnlsTol = 100)) 
summary(nlme_random_temp_only)
```

## - 2. lmer package ----

# .... a) lme() ----

nlme_br1_all_varExp_sim_sens \<- nlme(model= r \~ briere1(a,temp =
temp,Tmin,Tmax), start = starts_all_sim_sens, fixed = a+Tmin+Tmax \~1,
groups = \~id, \# same as random effects = a+Tmin+Tmax \~ 1\| id #random
=a+Tmin+Tmax\~1\|id, data = IR_data_sim_sens, weights = varExp(),
na.action=na.exclude, control = nlmeControl(pnlsTol = 1, msMaxIter =
100, msVerbose = TRUE))#to avoid error of singularity in backsolve at
level 0; block 1

## 3. `brms` package

#### 3.1. Random-intercept (SMD)

First with
dmeta::[ThirdWave](https://dmetar.protectlab.org/reference/ThirdWave.html)
dataset. It has a standardised mean difference as effect-size

```{r}
ThirdWave
```

Let's first use a `lme` model:

```{r}
lme_1<- lme(TE  ~ 1,
            random = ~ 1|Author,
            weights = ~ parameters::standard_error(seTE),
            data = ThirdWave)
lme_1
summary(lme_1)

```

We see here that the *τ*^2^ is **0.443** (*between-studies
heterogeneity)*. The *within-studies* heterogeneity value is 0.166. The
**estimate** (summary effect) is **0.643**

Now let's see this example with `brms`. First we define the prior.
According to Harrer et al. 2021 (cite it!), null model says a
standardized mean difference oscillates around 0 (-1, +1) and the
between study heterogeneity is assume to be around 0 with *s = 0.5* in
conservative approaches, so that the estimate prior is set as follows:

```{r}
prior_ranint_1 <-  c(set_prior("normal(0,1)", class = "Intercept"),
                     set_prior("cauchy(0,0.5)", class = "sd"))
```

And fit the model:

```{r}
bayes_mod_1 <- brm(TE|se(seTE) ~ 1 + (1|Author),
                   data = ThirdWave,
                   prior = prior_ranint_1,
                   iter = 4000)
summary(bayes_mod_1)
```

As in the example, the *between-studies* *heterogeneity* is **0.29**
with a BCI of [0.12, 0.51]; the estimate (*summary effect)* is **0.57**,
with a 95% BCI [0.40, 0.76].

#### 3.2. incorporating a covariate: meta-regression

Now we fit a **hierarchical model with meta-regression**. We will use
the `dmetar::MVRegressionData`.

```{r}
dataset_metareg <- MVRegressionData %>% 
  mutate(id = seq(1:length(yi)))
kable(dataset_metareg)
```

First, let's fit a `lme` model for y~*i*~ \~ publication year
(meta-regression) with *id* as study marker.

```{r}
lme_ranreg_1 <- lme(yi ~ pubyear,
                  weights = ~se(sei),
                  random = ~ 1|id,
                  data = dataset_metareg)
lme_ranreg_1
summary(lme_ranreg_1)

```

Here, the **summary estimate intercept** is **0.59** and the **summary
estimate slope** is **0.444.** (including se, 0.64 and 0.50 with *τ* ^2^
= 0.354).

The **between-studies heterogeneity** *τ* ^2^ = 1.15e-05 and a
**within-studies heterogeneity** of 0.684. Now we have 36 observations
rather than 18, since there are now two parameters (slope and intercept)
for each observation rather than 1 in the previous example (only an
intercept for each study).

Let's fit it with bayesian inference using `brms`. First of all, we need
to set a prior. Let's see what parameters and what values are assigned
by default in brm():

```{r}
bayes_mod_2 <- brm(yi|se(sei) ~ pubyear + (1|id),
                   data = dataset_metareg,
                   iter = 4000)
prior_summary(bayes_mod_2)
summary(bayes_mod_2)
kable(prior_summary(bayes_mod_2))

```

With noninformative priors, **estimates** are similar (0.58 for
intercept and 0.42 for slope). **Between-studies heterogeneity** is now
0.17 (BCI: [0.03,0.31]).

```{r}

prior_ranint_1 <-  c(set_prior("normal(0,1)", class = "Intercept"),
                     set_prior("cauchy(0,0.5)", class = "sd"))

```

```{r}
bayes_mod_1 <- brm(yi|(sei) ~ pubyear + (1|id),
                   data = dataset_metareg,
                   prior = prior_ranint_1,
                   iter = 4000)
summary(bayes_mod_1)
```

a
